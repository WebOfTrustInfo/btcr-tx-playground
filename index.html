<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>BTCR Playground</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.4.12/jsonld.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.5.0/sha256.min.js"></script>
    <script src="txrefConverter.js"></script>
    <script src="./forge.min.js"></script>
</head>
<body style="padding: 20px; font-family:Arial">
<h1>BTCR TX Conversion Playground</h1>
<div>
    <p><small>This is a prototype BTCR playground developed for the <a href="https://github.com/WebOfTrustInfo/btcr-hackathon" target="new">Rebooting Web of Trust BTCR Hackathon</a>. The source code for this repo is located at <a href="https://github.com/WebOfTrustInfo/btcr-tx-playground.github.io" target="new">btcr-tx-playground.github.io</a> and the javascript tx ref source code is available at <a href="https://github.com/WebOfTrustInfo/txref-conversion-js" target="new">txref-conversion-js</a></small></p>
</div>
<div>

    <h2>Transaction ID</h2>

    <p>
        <textarea contenteditable="true" id="txid" cols="80">f8cdaff3ebd9e862ed5885f8975489090595abe1470397f79780ead1c7528107</textarea>
        <br>

    <fieldset style="color:#474774; background:#EBEFFB; border:#BBBDD6 solid 1px; padding:1px 10px;">
    <legend>Select blockchain for Transaction ID</legend>
        <input type="radio" id="testnet3Chain" name="chainSelection" value="testnet3" checked="checked" />Bitcoin testnet3<br />
        <input type="radio" id="mainnetChain" name="chainSelection" value="mainnet" />Bitcoin mainnet<br />
    </fieldset>

    </p>
    <button id="btn1" onclick="JavaScript:convertToTxRef()">Convert to TX Ref</button>

</div>


<div>

    <h2>TX Ref</h2>
    <p>
        <textarea contenteditable="true" id="txref" cols="80"></textarea>
    </p>
    <button id="btn2" onclick="JavaScript:convertToTxid()">Convert to TXID</button>

</div>

<div>
    <h2>Transaction Summary</h2>
    <p>

    <table cellpadding="10">
        <tr>
            <th>Transaction</th>
            <td id="txidLink"></td>
        </tr>
        <tr>
            <th>DDO</th>
            <td id="ddo"></td>
        </tr>
        <tr>
            <th>Block Height</th>
            <td id="height"></td>
        </tr>
        <tr>
            <th>Block Position</th>
            <td id="pos"></td>
        </tr>
        <tr>
            <th>Received Date</th>
            <td id="received"></td>
        </tr>
        <tr>
            <th>Confirmed Date</th>
            <td id="confirmed"></td>
        </tr>
    </table>
    </p>
</div>

<div>
    <h2>Deterministic DDO</h2>
    <div id="d-ddo">
        <pre>

        </pre>
    </p>
</div>


<div>
    <h2>Examples</h2>
    <ul>
        <li>Example 1
            <ul>
                <li>TXID: 016b71d9ec62709656504f1282bb81f7acf998df025e54bd68ea33129d8a425b/mainnet</li>
                <li>TX Ref: tx1-rk63-uvxf-9pqc-sy</li>
            </ul>
    </ul>
</div>


<script>

  function clearStatusFull() {
    document.getElementById('height').innerHTML = "";
    document.getElementById('pos').innerHTML = "";
    clearStatusPartial();

  }

  function clearStatusPartial() {
    document.getElementById('received').innerHTML = "";
    document.getElementById('confirmed').innerHTML = "";
    document.getElementById('ddo').innerHTML = "";
    document.getElementById('txidLink').innerHTML = "";
  }

  var formatUrl = function (theUrl) {
    var txLink = "<a href=\"" + theUrl + "\" target='new'>" + theUrl + "</a>";
    return txLink;
  };

  function convertToTxRef() {
    var txElement = document.getElementById('txid');
    var trefElement = document.getElementById('txref');
    var isMainnet = document.getElementById('mainnetChain').checked;
    var txid = txElement.value.trim();

    trefElement.value = "computing...";
    var chain = isMainnet ? "mainnet" : "testnet";
    var result = BtcrUtils.txidToTxref(txid, chain);
    result.then(function (result) {
      trefElement.value = result;
      BtcrUtils.getTxDetails(txid, chain)
        .then(function (result) {
          var theUrl = isMainnet ? "https://api.blockcypher.com/v1/btc/main/txs/" + txid : "https://api.blockcypher.com/v1/btc/test3/txs/" + txid;
          var txLink = formatUrl(theUrl);
          var txRef = document.getElementById('txidLink');
          txRef.innerHTML = txLink;

          var blockUrl = isMainnet ? "https://live.blockcypher.com/btc/block/" + result.blockHeight :
          "https://live.blockcypher.com/btc-testnet/block/" + result.blockHeight;
          var blockHeightLink = "<a href=\"" + blockUrl + "\" target='new'>" + result.blockHeight.toString() + "</a>"
          document.getElementById('height').innerHTML = blockHeightLink;

          var posUrl = blockUrl + "/" + result.blockIndex.toString();
          var blockPosLink = "<a href=\"" + posUrl + "\" target='new'>" + result.blockIndex.toString() + "</a>"
          document.getElementById('pos').innerHTML = blockPosLink;

          document.getElementById('received').innerHTML = result.txReceived;
          document.getElementById('confirmed').innerHTML = result.txConfirmed;

          var opReturnData = null;
          for (var i = 0; i < result.outputs.length; i++) {
            var output = result.outputs[i];
            if (output.dataString != null) {
              opReturnData = output.dataString;
            }
          }
          document.getElementById('ddo').innerHTML = formatUrl(opReturnData);

          var deterministicDid = toDeterministicDid(result);
          document.getElementById('d-ddo').innerHTML = "<pre>" + JSON.stringify(deterministicDid, null, 4) + "</pre>";
        }, function (err) {
          clearStatusFull();
          trefElement.value = "error looking up transaction";
        });
    }, function (err) {
      clearStatusFull();
      trefElement.value = "error looking up transaction. Make sure the right chain is selected";
    });

  }

  function convertToTxid() {
    var txElement = document.getElementById('txref');
    var txidElement = document.getElementById('txid');
    txidElement.value = "computing...";
    var txref = txElement.value.trim();
    var isMainnet = txref.charAt(4) == 'r';

    // decode txref to get block height and index
    var decoded = BtcrUtils.txrefDecode(txref);
    if (!decoded) {
      txidElement.value = "error decoding txref. This is not a valid value";
      clearStatusFull();
      return;
    }

    var blockUrl = isMainnet ? "https://live.blockcypher.com/btc/block/" + decoded.blockHeight :
        "https://live.blockcypher.com/btc-testnet/block/" + decoded.blockHeight;
    var blockHeightLink = "<a href=\"" + blockUrl + "\" target='new'>" + decoded.blockHeight.toString() + "</a>"
    document.getElementById('height').innerHTML = blockHeightLink;

    var posUrl = blockUrl + "/" + decoded.blockIndex.toString();
    var blockPosLink = "<a href=\"" + posUrl + "\" target='new'>" + decoded.blockIndex.toString() + "</a>"
    document.getElementById('pos').innerHTML = blockPosLink;

    // update mainnet/testnet
    if (isMainnet) {
      document.getElementById('mainnetChain').checked = true;
    } else {
      document.getElementById('testnet3Chain').checked = true;
    }

    var result = BtcrUtils.txrefToTxid(txref);
    result.then(function (result) {
        txidElement.value = result;
        var chain = mainnetCheckbox.checked ? "mainnet" : "testnet";
        BtcrUtils.getTxDetails(result, chain)
          .then(function (result) {
            document.getElementById('received').innerHTML = result.txReceived;
            document.getElementById('confirmed').innerHTML = result.txConfirmed;

            var opReturnData = null;
            for (var i = 0; i < result.outputs.length; i++) {
              var output = result.outputs[i];
              if (output.dataString != null) {
                opReturnData = output.dataString;
              }
            }
            document.getElementById('ddo').innerHTML = formatUrl(opReturnData);
            var deterministicDid = toDeterministicDid(result);
            document.getElementById('d-ddo').innerHTML = "<pre>" + JSON.stringify(deterministicDid, null, 4) + "</pre>";
          }, function (err) {
            txidElement.value = "error looking up transaction details. This could be hitting API rate limits. You can lookup transaction details given the block height, index, and chain";
            clearStatusPartial();
          });
      }, function (err) {
        txidElement.value = "error looking up transaction by id. This could be hitting API rate limits. You can lookup transaction details given the block height, index, and chain";
        clearStatusPartial();
      }
    );

  }

  function toDeterministicDid(txDetails) {
    var result = {
      "@context": [ "https://schema.org/",  "https://w3id.org/security/v1"]
    };

    var fundingTxref = txDetails.inputs[0].previousHash;
    var inputValue = txDetails.inputs[0].outputValue * 0.00000001;

    var ddoHex = null;
    var ddoAsm = null;
    var ddoText = null;
    var proofType = null;
    var outputValue = 0;
    var outputAddress = null;
    for (var i = 0; i < txDetails.outputs.length; i++) {
      var output = txDetails.outputs[i];
      if (output.dataString != null) {
        ddoHex = output.script;
        ddoAsm = "OP_RETURN " + output.dataHex;
        ddoText = output.dataString;
      } else {
        proofType = output.scriptType;
        outputValue = output.outputValue * 0.00000001;
        outputAddress = output.addresses[0];
      }
    }

    var burnFee = outputValue - inputValue;

    var ddo = {
      "txid": txDetails.txHash,
      "funding-txid": txDetails.inputs[0].previousHash,
      "funding-txref": "TODO",
      "hash": txDetails.txHash,
      "more-ddo-hex": ddoHex,
      "more-ddo-asm": ddoAsm,
      "more-ddo-txt": ddoText,
      "owner": [
        {
          "id": "todo",
          "type": [ "CryptographicKey", "EdDsaSAPublicKey", "update-proof" ],
          "curve": "secp256k1",
          "publicKeyHex": "todo"
        }
      ],
      "control": [
        {
          "control-bond": outputValue,
          "rotate-proof": [
            {
              "proof-type": proofType,
              "hash-base58check": outputAddress
            }
          ],
          "revocation-proof": [
            {
              "bond-value": outputValue,
              "proof-type": proofType,
              "hash-base58check": outputAddress
            }
          ]
        }
      ]
    };
    var signature = {
      "type": "SatoshiBlockchainSignature2017",
      "id": "todo",
      "chain": txDetails.chain,
      "blockhash": txDetails.blockHash,
      "blockindex": txDetails.blockIndex,
      "blocktime": txDetails.txConfirmed,
      "confirmations": txDetails.numConfirmations,
      "time": txDetails.txReceived,
      "timereceived": txDetails.txReceived,
      "burn-fee": burnFee
    };
    result.ddo = ddo;
    result.signature = signature;
    return result;
  }

</script>


</body>
</html>