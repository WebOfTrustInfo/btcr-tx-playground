<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>BTCR Playground</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.4.12/jsonld.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.5.0/sha256.min.js"></script>
    <script src="txrefConverter.js"></script>
    <script src="./forge.min.js"></script>
</head>
<body style="padding: 20px; font-family:Arial">
<h1>BTCR TX Conversion Playground</h1>
<div>

    <h2>Transaction ID</h2>

    <p>
        <textarea contenteditable="true" id="txid" cols="80">f8cdaff3ebd9e862ed5885f8975489090595abe1470397f79780ead1c7528107</textarea>
        <br>
        Mainnet?<input id="checkBox" type="checkbox">
    </p>
    <button id="btn1" onclick="JavaScript:convertToBtcrId()">Convert to BTCR DID</button>

</div>


<div>

    <h2>BTCR DID</h2>
    <p>
        <textarea contenteditable="true" id="did" cols="80"></textarea>
    </p>
    <button id="btn2" onclick="JavaScript:convertToTxid()">Convert to TXID</button>

</div>

<div>
    <h2>Transaction Details</h2>
    <p>

    <table cellpadding="10">
        <tr>
            <th>Transaction</th>
            <td id="txDetails"></td>
        </tr>
        <tr>
            <th>DDO</th>
            <td id="ddo"></td>
        </tr>
        <tr>
            <th>Block Height</th>
            <td id="height"></td>
        </tr>
        <tr>
            <th>Block Position</th>
            <td id="pos"></td>
        </tr>
        <tr>
            <th>Received Date</th>
            <td id="received"></td>
        </tr>
        <tr>
            <th>Confirmed Date</th>
            <td id="confirmed"></td>
        </tr>
    </table>
    <h3>Inputs:</h3>

    <div id="inputs" style="background-color:#E0E0E0; overflow: auto;"></div>

    <h3>Ouputs:</h3>
    <div id="outputs" style="background-color:#E0E0E0; overflow: auto;"></div>

    </p>
</div>


<div>
    <h2>Examples</h2>
    <ul>
        <li>Example 1
            <ul>
                <li>TXID: 016b71d9ec62709656504f1282bb81f7acf998df025e54bd68ea33129d8a425b/mainnet</li>
                <li>BTCR DID: tx1-rk63-uvxf-9pqc-sy</li>
            </ul>
    </ul>
</div>


<script>

  var formatUrl = function (theUrl) {
    var txLink = "<a href=\"" + theUrl + "\" target='new'>" + theUrl + "</a>";
    return txLink;
  };

  function convertToBtcrId() {
    var txElement = document.getElementById('txid');
    var didElement = document.getElementById('did');
    var checkBox = document.getElementById('checkBox');

    var txid = txElement.value;

    var isMainnet = checkBox.checked;

    var theUrl = isMainnet ? "https://api.blockcypher.com/v1/btc/main/txs/" + txid : "https://api.blockcypher.com/v1/btc/test3/txs/" + txid;
    var txLink = formatUrl(theUrl);
    var txRef = document.getElementById('txDetails');
    txRef.innerHTML = txLink;

    didElement.value = "computing...";
    var chain = isMainnet ? "mainnet" : "testnet";
    var result = BtcrUtils.txidToBech32(txid, chain);
    result.then(function (result, err) {
      if (err) {
        didElement.value = "error looking up transaction"
      } else {
        didElement.value = result;
      }
    });

    BtcrUtils.getTxDetails(txid, chain)
      .then(function (result, err) {

        var blockUrl = isMainnet ? "https://live.blockcypher.com/btc/block/" + result.blockHeight :
            "https://live.blockcypher.com/btc-testnet/block/" + result.blockHeight;
        var blockHeightLink = "<a href=\"" + blockUrl + "\" target='new'>" + result.blockHeight.toString() + "</a>"
        document.getElementById('height').innerHTML = blockHeightLink;

        var posUrl = blockUrl + "/" + result.blockIndex.toString();
        var blockPosLink = "<a href=\"" + posUrl + "\" target='new'>" + result.blockIndex.toString() + "</a>"
        document.getElementById('pos').innerHTML = blockPosLink;

        document.getElementById('received').innerHTML = result.txReceived;
        document.getElementById('confirmed').innerHTML = result.txConfirmed;
        document.getElementById('inputs').innerHTML = "<pre>" + JSON.stringify(result.inputs, null, 4) + "</pre>";
        document.getElementById('outputs').innerHTML = "<pre>" + JSON.stringify(result.outputs, null, 4) + "</pre>";

        var opReturnData = null;
        for (var i=0; i<result.outputs.length; i++) {
          var output = result.outputs[i];
          if (output.data != null) {
            opReturnData = output.data
          }
        }
        document.getElementById('ddo').innerHTML = formatUrl(opReturnData);

      });
  }

  function convertToTxid() {

    var txElement = document.getElementById('did');
    var txidElement = document.getElementById('txid');
    txidElement.value = "computing...";
    var did = txElement.value;
    var result = BtcrUtils.bech32ToTxid(did);
    result.then(function (result, err) {
      txidElement.value = result;
      var checkBox = document.getElementById('checkBox');
      checkBox.checked = did.charAt(4) == 'r';

      var isMainnet = checkBox.checked;
      var chain = isMainnet ? "mainnet" : "testnet";
      BtcrUtils.getTxDetails(result, chain)
        .then(function (result, err) {

          var blockUrl = isMainnet ? "https://live.blockcypher.com/btc/block/" + result.blockHeight :
          "https://live.blockcypher.com/btc-testnet/block/" + result.blockHeight;
          var blockHeightLink = "<a href=\"" + blockUrl + "\" target='new'>" + result.blockHeight.toString() + "</a>"
          document.getElementById('height').innerHTML = blockHeightLink;

          var posUrl = blockUrl + "/" + result.blockIndex.toString();
          var blockPosLink = "<a href=\"" + posUrl + "\" target='new'>" + result.blockIndex.toString() + "</a>"
          document.getElementById('pos').innerHTML = blockPosLink;

          document.getElementById('received').innerHTML = result.txReceived;
          document.getElementById('confirmed').innerHTML = result.txConfirmed;
          document.getElementById('inputs').innerHTML = "<pre>" + JSON.stringify(result.inputs, null, 4) + "</pre>";
          document.getElementById('outputs').innerHTML = "<pre>" + JSON.stringify(result.outputs, null, 4) + "</pre>";

          var opReturnData = null;
          for (var i=0; i<result.outputs.length; i++) {
            var output = result.outputs[i];
            if (output.data != null) {
              opReturnData = output.data
            }
          }
          document.getElementById('ddo').innerHTML = formatUrl(opReturnData);

        });
    });

  }

</script>


</body>
</html>