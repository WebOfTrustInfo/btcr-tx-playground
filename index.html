<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>BTCR Playground</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/0.4.12/jsonld.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.5.0/sha256.min.js"></script>
    <script src="btcrDidUtils.js"></script>
    <script src="./forge.min.js"></script>
</head>
<body style="padding: 20px; font-family:Arial">
<h1>BTCR TX Conversion Playground</h1>
<div>
    <p><small>This is a prototype BTCR playground developed for the <a href="https://github.com/WebOfTrustInfo/btcr-hackathon" target="new">Rebooting Web of Trust BTCR Hackathon</a>. The source code for this repo is located at <a href="https://github.com/WebOfTrustInfo/btcr-tx-playground.github.io" target="new">btcr-tx-playground.github.io</a> and the javascript tx ref source code is available at <a href="https://github.com/WebOfTrustInfo/txref-conversion-js" target="new">txref-conversion-js</a></small></p>
    <p><small>
        <a href="https://github.com/WebOfTrustInfo/rebooting-the-web-of-trust-fall2017/blob/master/topics-and-advance-readings/btcr-dids-ddos.md" target="new">BTCR DIDs and DDOs</a></small></p> describes the output shown here.
</div>
<div>

    <h2>Transaction ID</h2>
    <div style="color:#474774; background:#EBEFFB; border:#BBBDD6 solid 1px; padding:1px 10px;">

    <p>
        <textarea contenteditable="true" id="txid" cols="80">f8cdaff3ebd9e862ed5885f8975489090595abe1470397f79780ead1c7528107</textarea>
        <br>

    <fieldset style="border:#BBBDD6 solid 1px; padding:1px 10px;">
    <legend>Select blockchain</legend>
        <input type="radio" id="testnet3Chain" name="chainSelection" value="testnet3" checked="checked" />Bitcoin testnet3<br />
        <input type="radio" id="mainnetChain" name="chainSelection" value="mainnet" />Bitcoin mainnet<br />
    </fieldset>

    </p>
    <button id="btn1" onclick="JavaScript:convertFromTxid()">Convert from TXID</button>
    </div>

</div>


<div>

    <h2>TX Ref</h2>
    <div style="color:#474774; background:#EBEFFB; border:#BBBDD6 solid 1px; padding:1px 10px;">
    <p>
        <textarea contenteditable="true" id="txref" cols="80"></textarea>
    </p>
    <button id="btn2" onclick="JavaScript:convertFromTxref()">Convert from TX Ref</button>
    </div>

</div>

<div>

    <h2>Transaction Block Height/Position</h2>
    <div style="color:#474774; background:#EBEFFB; border:#BBBDD6 solid 1px; padding:1px 10px; vertical-align: middle;">

        <p>
            <label for="blockHeight" style="vertical-align: middle;">Block Height</label>
            <textarea contenteditable="true" id="blockHeight" cols="30" style="vertical-align: middle;"></textarea>
            &nbsp;&nbsp;
            <label for="blockPosition" style="vertical-align: middle;">Block Position</label>
            <textarea contenteditable="true" id="blockPosition" cols="30" style="vertical-align: middle;"></textarea>
            <br>

        <fieldset style="border:#BBBDD6 solid 1px; padding:1px 10px;">
            <legend>Select blockchain</legend>
            <input type="radio" id="testnet3Chain2" name="chainSelection2" value="testnet3" checked="checked" />Bitcoin testnet3<br />
            <input type="radio" id="mainnetChain2" name="chainSelection2" value="mainnet" />Bitcoin mainnet<br />
        </fieldset>

        </p>
        <button id="btn3" onclick="JavaScript:convertFromBlockheightPos()">Convert from Block Height and Position</button>
    </div>

</div>

<div>
    <h2>Transaction Summary</h2>
    <div style="color:#474774; background:#EBEFFB; border:#BBBDD6 solid 1px; padding:1px 10px;">
    <p>

    <table cellpadding="10">
        <tr>
            <th>Transaction</th>
            <td id="txidLink"></td>
        </tr>
        <tr>
            <th>Block Height</th>
            <td id="height"></td>
        </tr>
        <tr>
            <th>Block Position</th>
            <td id="pos"></td>
        </tr>
        <tr>
            <th>Received Date</th>
            <td id="received"></td>
        </tr>
        <tr>
            <th>Confirmed Date</th>
            <td id="confirmed"></td>
        </tr>
    </table>
    </p>
    </div>
</div>

<div>
    <h2>Deterministic DDO; Fragment /0</h2>
    <div id="d-ddo" style="color:#474774; background:#EBEFFB; border:#BBBDD6 solid 1px; padding:1px 10px;">
        <pre>

        </pre>

    </div>

    <h2>Fragment /1</h2>
    <div id="fragment1" style="color:#474774; background:#EBEFFB; border:#BBBDD6 solid 1px; padding:1px 10px;">
        <pre>

        </pre>
    </div>

</div>


<script>

  var toDisplayChain = function (chain) {
    return chain === "testnet" ? "testnet3" : chain;
  };

  var clearStatusFull = function() {
    document.getElementById('height').innerHTML = "";
    document.getElementById('pos').innerHTML = "";
    clearStatusPartial();
  };

  var clearStatusPartial = function() {
    document.getElementById('received').innerHTML = "";
    document.getElementById('confirmed').innerHTML = "";
    document.getElementById('txidLink').innerHTML = "";
    document.getElementById('d-ddo').innerHTML = "<pre></pre>";
    document.getElementById('fragment1').innerHTML = "<pre></pre>";
  };

  var updateTxDetails = function (result, isMainnet) {
    updateBlockHeightAndPos(result.txDetails.blockHeight, result.txDetails.blockIndex, isMainnet);
    updateTxLink(isMainnet, result.txDetails.txid);

    document.getElementById('received').innerHTML = result.txDetails.txReceived;
    document.getElementById('confirmed').innerHTML = result.txDetails.txConfirmed;
    document.getElementById('d-ddo').innerHTML = "<pre>" + JSON.stringify(result.deterministicDdo, null, 4) + "</pre>";
    document.getElementById('fragment1').innerHTML = "<pre>" + JSON.stringify(result.fragment1, null, 4) + "</pre>";
  };

  var formatUrl = function (theUrl) {
    var txLink = "<a href=\"" + theUrl + "\" target='new'>" + theUrl + "</a>";
    return txLink;
  };

  var updateBlockHeightAndPos = function (blockHeight, blockIndex, isMainnet) {
    // update mainnet/testnet
    if (isMainnet) {
      document.getElementById('mainnetChain').checked = true;
      document.getElementById('mainnetChain2').checked = true;
    } else {
      document.getElementById('testnet3Chain').checked = true;
      document.getElementById('testnet3Chain2').checked = true;
    }

    var blockUrl = isMainnet ? "https://live.blockcypher.com/btc/block/" + blockHeight :
      "https://live.blockcypher.com/btc-testnet/block/" + blockHeight;

    var blockHeightLink = "<a href=\"" + blockUrl + "\" target='new'>" + blockHeight.toString() + "</a>"
    document.getElementById('height').innerHTML = blockHeightLink;

    var posUrl = blockUrl + "/" + blockIndex.toString();
    var blockPosLink = "<a href=\"" + posUrl + "\" target='new'>" + blockIndex.toString() + "</a>";
    document.getElementById('pos').innerHTML = blockPosLink;

    document.getElementById('blockHeight').value = blockHeight;
    document.getElementById('blockPosition').value = blockIndex;
  };

  var updateTxLink = function (isMainnet, txid) {
    var theUrl = isMainnet ? "https://api.blockcypher.com/v1/btc/main/txs/" + txid : "https://api.blockcypher.com/v1/btc/test3/txs/" + txid;
    var txLink = formatUrl(theUrl);
    var txRef = document.getElementById('txidLink');
    txRef.innerHTML = txLink;
  };

  var convertFromTxid = function () {
    var txidElement = document.getElementById('txid');
    var txrefElement = document.getElementById('txref');
    var isMainnet = document.getElementById('mainnetChain').checked;
    var txid = txidElement.value.trim();

    txrefElement.value = "computing...";
    var chain = isMainnet ? "mainnet" : "testnet";

    BtcrUtils.getDeterministicDdoFromTxid(txid, chain)
      .then(function (result) {
        txrefElement.value = result.txDetails.txref;
        updateTxDetails(result, isMainnet);
      }, function (err) {
        txidElement.value = "error looking up transaction. This may not a valid value";
        clearStatusFull();
      });
  };

  var convertFromTxref = function () {
    var txrefElement = document.getElementById('txref');
    var txidElement = document.getElementById('txid');
    txidElement.value = "computing...";
    var txref = txrefElement.value.trim();
    var isMainnet = txref.charAt(4) == 'r';

    BtcrUtils.getDeterministicDdoFromTxref(txref)
      .then(function (result) {
        txidElement.value = result.txDetails.txid;
        updateTxDetails(result, isMainnet);
      }, function (err) {
        txidElement.value = "error decoding txref. This may not a valid value";
        clearStatusFull();
      });
  };

  var resolveFragment1 = function() {
    var fragment1Element = document.getElementById('fragment1');
    var request = new XMLHttpRequest();
    request.addEventListener('load', function() {
      var status = request.status;if (status != 200) {
        // TODO: fail
      }
      try {
        var responseData = JSON.parse(request.responseText);
        fragment1Element.innerHTML = request.responseText;
      } catch (e) {
        // try next handler
        //return this._lookForTx(index + 1, items, completionCallback);
      }
    });
    request.open('GET', fragment1Element.innerHTML);
    request.responseType = "json";
    request.send();
  }


</script>


</body>
</html>